# å·¥ä½œæµåç§°ï¼šæ„å»º iStore OS 6.x-MTKWIFI å›ºä»¶
name: Build iStore OS 6.x-MTKWIFI

# è§¦å‘å·¥ä½œæµçš„æ¡ä»¶
on:
  # 1. ä»“åº“è°ƒåº¦è§¦å‘ï¼ˆå¤–éƒ¨/å…¶ä»–å·¥ä½œæµè§¦å‘ï¼‰
  repository_dispatch:
  # 2. æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨GitHubä»“åº“Actionsé¡µé¢æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œï¼‰
  workflow_dispatch:
    # ä»¥ä¸‹ä¸ºæ³¨é‡Šæ‰çš„SSHè¾“å…¥é…ç½®ï¼ˆå¦‚éœ€è¿œç¨‹è¿æ¥è°ƒè¯•å¯å¯ç”¨ï¼‰
    # inputs:
      # ssh:
        # description: 'SSH connection to Actions'
        # required: false
        # default: 'false'
  # 3. å®šæ—¶è§¦å‘ï¼ˆCronè¡¨è¾¾å¼ï¼ŒUTCæ—¶é—´16:00 = åŒ—äº¬æ—¶é—´00:00ï¼‰
  schedule:
   - cron: 0 16 * * *

# å…¨å±€ç¯å¢ƒå˜é‡é…ç½®ï¼ˆæ•´ä¸ªå·¥ä½œæµå¯å…±äº«ï¼‰
env:
  REPO_URL: https://github.com/istoreos/istoreos  # iStore OS æºç ä»“åº“åœ°å€
  # REPO_BRANCH: main  # æ³¨é‡Šæ‰çš„é»˜è®¤æºç åˆ†æ”¯
  FEEDS_CONF: feeds.conf  # è½¯ä»¶æºé…ç½®æ–‡ä»¶å
  CONFIG_FILE: .config  # å›ºä»¶ç¼–è¯‘é…ç½®æ–‡ä»¶å
  DIY_P1_SH: diy-part1-6.x.sh  # ç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬ï¼ˆå‰æœŸå‡†å¤‡ï¼‰
  DIY_P2_SH: diy-part3-6.x-mtkwifi.sh  # ç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬ï¼ˆè”å‘ç§‘WiFiä¸“å±é…ç½®ï¼‰
  UPLOAD_BIN_DIR: true  # æ˜¯å¦ä¸Šä¼ å®Œæ•´çš„binç¼–è¯‘ç›®å½•
  UPLOAD_FIRMWARE: true  # æ˜¯å¦ä¸Šä¼ æ•´ç†åçš„å›ºä»¶æ–‡ä»¶
  UPLOAD_RELEASE: true  # æ˜¯å¦è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ°GitHub Releases
  TZ: Asia/Shanghai  # æ„å»ºç¯å¢ƒæ—¶åŒºè®¾ç½®ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}  # GitHubè®¿é—®ä»¤ç‰Œï¼ˆç”¨äºæ“ä½œReleasesã€åˆ é™¤æ—§è®°å½•ç­‰ï¼‰

# å®šä¹‰å·¥ä½œæµä»»åŠ¡ï¼ˆæ ¸å¿ƒæ‰§è¡Œæ­¥éª¤ï¼‰
jobs:
  # å•ä¸ªä»»åŠ¡ï¼šæ„å»ºå›ºä»¶ï¼ˆä»»åŠ¡åç§°ä¸ºbuildï¼‰
  build:
    # ä»»åŠ¡è¿è¡Œçš„è™šæ‹Ÿæœºç¯å¢ƒï¼ˆç”±matrixçŸ©é˜µåŠ¨æ€æŒ‡å®šï¼‰
    runs-on: ${{ matrix.os }}
    # çŸ©é˜µé…ç½®ï¼ˆå¤šå‚æ•°ç»„åˆæ‰§è¡Œï¼Œæ­¤å¤„å®é™…ä¸ºå•ç»„åˆï¼Œä¾¿äºåç»­æ‰©å±•ï¼‰
    strategy:
      matrix:
        # æºç åˆ†æ”¯é€‰æ‹©ï¼ˆå¯ç”¨istoreos-24.10åˆ†æ”¯ï¼Œæ³¨é‡Šæ‰å…¶ä»–åˆ†æ”¯ï¼‰
        REPO_BRANCH:
          # - main
          - istoreos-24.10
          # - istoreos-23.05
        # å›ºä»¶æ¶æ„é€‰æ‹©ï¼ˆARMv8æ¶æ„ï¼Œé€‚é…ä¸»æµåµŒå…¥å¼è®¾å¤‡ï¼‰
        ARCHITECTURE:
          - armv8
        # æ„å»ºç³»ç»Ÿç¯å¢ƒé€‰æ‹©ï¼ˆUbuntu 22.04 LTSï¼‰
        os:
          - ubuntu-22.04

      # å…³é—­å¿«é€Ÿå¤±è´¥ï¼šæŸä¸ªçŸ©é˜µç»„åˆæ‰§è¡Œå¤±è´¥ï¼Œä¸å½±å“å…¶ä»–ç»„åˆï¼ˆæ­¤å¤„å•ç»„åˆï¼Œæ— å®é™…å½±å“ï¼‰
      fail-fast: false

    # ä»»åŠ¡æ‰§è¡Œæ­¥éª¤ï¼ˆæŒ‰é¡ºåºä¾æ¬¡è¿è¡Œï¼‰
    steps:
    # æ­¥éª¤1ï¼šåˆå¹¶è™šæ‹Ÿæœºç£ç›˜ç©ºé—´ï¼ˆè§£å†³ç¼–è¯‘å›ºä»¶ç£ç›˜ä¸è¶³é—®é¢˜ï¼‰
    - name: åˆå¹¶ç£ç›˜
      uses: easimon/maximize-build-space@master  # è°ƒç”¨ç¬¬ä¸‰æ–¹ç£ç›˜æ‰©å®¹Action
      with:
        swap-size-mb: 1024  # è®¾ç½®äº¤æ¢åˆ†åŒºå¤§å°1024MB
        temp-reserve-mb: 100  # é¢„ç•™ä¸´æ—¶ç›®å½•ç©ºé—´100MB
        root-reserve-mb: 1024  # é¢„ç•™æ ¹ç›®å½•ç©ºé—´1024MB

    # æ­¥éª¤2ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆè·å–ç¼–è¯‘æ‰€éœ€çš„è„šæœ¬ã€é…ç½®æ–‡ä»¶ç­‰ï¼‰
    - name: å‡†å¤‡å®Œæˆ
      uses: actions/checkout@main  # è°ƒç”¨GitHubå®˜æ–¹æ£€å‡ºä»£ç Action

    # æ­¥éª¤3ï¼šåˆ›å»ºå·¥ä½œç›®å½•ï¼ˆç”¨äºå­˜æ”¾æºç å’Œç¼–è¯‘äº§ç‰©ï¼‰
    - name: åˆ›å»ºå·¥ä½œç›®å½•
      run: |
        # åˆ›å»ºå·¥ä½œç›®å½•ï¼ˆè·¯å¾„ï¼šGitHubå·¥ä½œç©ºé—´/workdirï¼‰
        mkdir -p ${GITHUB_WORKSPACE}/workdir
        # è®¾ç½®ç›®å½•æƒé™ä¸º755ï¼ˆæ‰€æœ‰è€…å¯è¯»å¯å†™å¯æ‰§è¡Œï¼Œå…¶ä»–ç”¨æˆ·å¯è¯»å¯æ‰§è¡Œï¼‰
        chmod 755 ${GITHUB_WORKSPACE}/workdir
        # å°†å·¥ä½œç›®å½•è·¯å¾„å†™å…¥ç¯å¢ƒå˜é‡ï¼Œåç»­æ­¥éª¤å¯å¤ç”¨
        echo "WORKDIR=$PWD" >> $GITHUB_ENV

    # æ­¥éª¤4ï¼šæ£€æŸ¥æœåŠ¡å™¨é…ç½®ï¼ˆæŸ¥çœ‹CPUã€å†…å­˜ã€ç£ç›˜ä¿¡æ¯ï¼Œç¡®è®¤ç¼–è¯‘ç¯å¢ƒæ˜¯å¦æ»¡è¶³è¦æ±‚ï¼‰
    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo "è‹¥åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½ä¸è¶³ï¼ŒåŠ¡å¿…åŠæ—¶å–æ¶ˆï¼Œé‡æ–°è¿è¡Œï¼"
        echo -e "------------------------------- CPUä¿¡æ¯ -------------------------------\n"
        # æŸ¥çœ‹CPUç‰©ç†æ ¸å¿ƒæ•°é‡
        echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
        # æŸ¥çœ‹CPUå‹å·å’Œé€»è¾‘æ ¸å¿ƒæ•°é‡
        echo -e "CPUæ ¸å¿ƒåŠç‰ˆæœ¬ä¿¡æ¯: $(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo -e "------------------------------- å†…å­˜ä¿¡æ¯ -------------------------------\n"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯: "
        # æŸ¥çœ‹å†…å­˜è¯¦ç»†ä¿¡æ¯ï¼ˆä»…æ˜¾ç¤ºGiBå•ä½ï¼‰
        sudo lshw -short -C memory | grep GiB
        echo -e "\n"
        echo -e "------------------------------- ç£ç›˜ä¿¡æ¯ -------------------------------\n"
        # æŸ¥çœ‹ç£ç›˜æ•°é‡
        echo -e "ç£ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l) \n"
        echo "------------------------------- ç£ç›˜è¯¦æƒ… -------------------------------\n"
        # æŸ¥çœ‹ç£ç›˜æŒ‚è½½ã€å®¹é‡ã€æ–‡ä»¶ç³»ç»Ÿç±»å‹
        df -Th

    # æ­¥éª¤5ï¼šåˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒï¼ˆå®‰è£…ä¾èµ–ã€æ¸…ç†å†—ä½™è½¯ä»¶ã€è®¾ç½®æ—¶åŒºï¼‰
    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        # ç¦ç”¨Debian/Ubuntuäº¤äº’å¼é…ç½®ï¼ˆé¿å…ç¼–è¯‘è¿‡ç¨‹ä¸­å¡ä½ï¼‰
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "------------------------------- æ›´æ–°å¹¶å®‰è£…ä¾èµ– -------------------------------"
        # åˆ é™¤å†—ä½™é…ç½®å’Œé¢„å®‰è£…è½¯ä»¶ï¼ˆé‡Šæ”¾ç£ç›˜ç©ºé—´ï¼‰
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android /opt/ghc
        # é™é»˜æ›´æ–°aptè½¯ä»¶æºï¼ˆ-qqï¼šé™é»˜æ¨¡å¼ï¼Œå‡å°‘è¾“å‡ºï¼‰
        sudo -E apt-get -qq update
        # é™é»˜å®‰è£…ç¼–è¯‘æ‰€éœ€ä¾èµ–ï¼ˆä¾èµ–åˆ—è¡¨æ¥è‡ªå½“å‰ä»“åº“çš„dependsç›®å½•å¯¹åº”ç³»ç»Ÿæ–‡ä»¶ï¼‰
        sudo -E apt-get -qq install $(cat $GITHUB_WORKSPACE/depends/${{ matrix.os }})
        # ä¸‹è½½å¹¶å®‰è£…pipï¼ˆPythonåŒ…ç®¡ç†å·¥å…·ï¼‰
        wget https://bootstrap.pypa.io/pip/3.6/get-pip.py
        sudo python3 get-pip.py
        sudo rm -rf get-pip.py
        # å®‰è£…ç¼–è¯‘æ‰€éœ€çš„PythonåŒ…ï¼ˆpyelftoolsï¼šç”¨äºè§£æELFæ–‡ä»¶ï¼‰
        sudo pip install pyelftools
        echo "------------------------------- æ¸…ç†Dockeré•œåƒå’Œè½¯ä»¶ -------------------------------"
        # åˆ é™¤æ‰€æœ‰Dockeré•œåƒï¼ˆé‡Šæ”¾å¤§é‡ç£ç›˜ç©ºé—´ï¼‰
        docker rmi `docker images -q`
        docker image prune -a -f
        # å¸è½½å¤§é‡å†—ä½™é¢„å®‰è£…è½¯ä»¶ï¼ˆè¿›ä¸€æ­¥é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼‰
        sudo -E apt-get -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* adoptopenjdk* mysql* php* mongodb* dotnet* moby* snapd* android* || true
        # è‡ªåŠ¨å¸è½½ä¸å†éœ€è¦çš„ä¾èµ–åŒ…
        sudo -E apt-get -qq autoremove --purge
        # æ¸…ç†aptç¼“å­˜æ–‡ä»¶
        sudo -E apt-get -qq clean
        echo "------------------------------- è®¾ç½®æ—¶åŒº -------------------------------"
        # å°†ç³»ç»Ÿæ—¶åŒºè®¾ç½®ä¸ºå…¨å±€ç¯å¢ƒå˜é‡ä¸­å®šä¹‰çš„æ—¶åŒºï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
        sudo timedatectl set-timezone "$TZ"

    # æ­¥éª¤6ï¼šå…‹éš†iStore OSæºç ï¼ˆä»å®˜æ–¹ä»“åº“æ‹‰å–æŒ‡å®šåˆ†æ”¯çš„æºç ï¼‰
    - name: å…‹éš†æºç 
      working-directory: ${{ env.WORKDIR }}/workdir  # åˆ‡æ¢åˆ°å·¥ä½œç›®å½•æ‰§è¡Œå‘½ä»¤
      run: |
        # æŸ¥çœ‹å½“å‰ç›®å½•ç£ç›˜ä½¿ç”¨æƒ…å†µ
        df -hT $PWD
        # å…‹éš†æºç ä»“åº“ï¼ŒæŒ‡å®šåˆ†æ”¯ï¼ˆmatrixä¸­é…ç½®çš„REPO_BRANCHï¼‰ï¼Œç›®å½•åopenwrt
        git clone $REPO_URL -b ${{ matrix.REPO_BRANCH }} openwrt
        # åˆ›å»ºè½¯é“¾æ¥ï¼ˆå°†æºç ç›®å½•é“¾æ¥åˆ°GitHubå·¥ä½œç©ºé—´ï¼Œæ–¹ä¾¿åç»­æ­¥éª¤è®¿é—®ï¼‰
        ln -sf ${{ env.WORKDIR }}/workdir/openwrt $GITHUB_WORKSPACE/openwrt

    # æ­¥éª¤7ï¼šç¼“å­˜æ„å»ºåŠ¨ä½œï¼ˆç¼“å­˜ç¼–è¯‘è¿‡ç¨‹ä¸­çš„ä¸­é—´æ–‡ä»¶ï¼ŒåŠ é€Ÿåç»­æ„å»ºï¼‰
    - name: ç¼“å­˜æ„å»ºåŠ¨ä½œ
      uses: klever1988/cachewrtbuild@main  # è°ƒç”¨OpenWrtç¼–è¯‘ç¼“å­˜ä¸“ç”¨Action
      with:
        ccache: 'true'  # å¯ç”¨ccacheç¼–è¯‘ç¼“å­˜
        # ç¼“å­˜å¯†é’¥ï¼ˆåŒ…å«ç³»ç»Ÿã€æ¶æ„ã€åˆ†æ”¯ã€å›ºä»¶ç±»å‹ï¼Œç¡®ä¿ç¼“å­˜å”¯ä¸€æ€§ï¼‰
        mixkey: ${{ matrix.os }}-${{ matrix.ARCHITECTURE }}-${{ matrix.REPO_BRANCH }}-mtkwifi
        # ç¼“å­˜ç›®å½•ï¼ˆæºç æ ¹ç›®å½•ï¼‰
        prefix: ${{ github.workspace }}/openwrt

    # æ­¥éª¤8ï¼šåŠ è½½è‡ªå®šä¹‰feedsï¼ˆé…ç½®è½¯ä»¶æºï¼Œæ‰§è¡Œç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬ï¼‰
    - name: åŠ è½½è‡ªå®šä¹‰ feeds
      env:
        # æ‹¼æ¥è‡ªå®šä¹‰feedsé…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆæ¶æ„/feeds.confï¼‰
        FEEDS_CONF_PATH: ${{ matrix.ARCHITECTURE }}/${{ env.FEEDS_CONF }}
      run: |
        # è‹¥è‡ªå®šä¹‰feedsé…ç½®æ–‡ä»¶å­˜åœ¨ï¼Œç§»åŠ¨åˆ°æºç ç›®å½•è¦†ç›–é»˜è®¤é…ç½®
        [ -e $FEEDS_CONF_PATH ] && mv $FEEDS_CONF_PATH openwrt/$FEEDS_CONF
        # ç»™ç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬æ·»åŠ å¯æ‰§è¡Œæƒé™
        chmod +x $DIY_P1_SH
        # åˆ‡æ¢åˆ°æºç ç›®å½•
        cd openwrt
        # æ‰§è¡Œç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬ï¼ˆé€šå¸¸ç”¨äºæ·»åŠ è‡ªå®šä¹‰è½¯ä»¶æºã€ä¿®æ”¹é»˜è®¤é…ç½®ç­‰ï¼‰
        $GITHUB_WORKSPACE/$DIY_P1_SH

    # æ­¥éª¤9ï¼šæ›´æ–°feedsè½¯ä»¶æºï¼ˆæ‹‰å–æœ€æ–°çš„è½¯ä»¶åŒ…åˆ—è¡¨ï¼‰
    - name: æ›´æ–° feeds
      run: cd openwrt && ./scripts/feeds update -a  # æ‰§è¡ŒOpenWrtè‡ªå¸¦è„šæœ¬ï¼Œæ›´æ–°æ‰€æœ‰feeds

    # æ­¥éª¤10ï¼šå®‰è£…feedsè½¯ä»¶åŒ…ï¼ˆå°†è½¯ä»¶åŒ…å®‰è£…åˆ°æºç ç›®å½•ï¼Œä¾›ç¼–è¯‘ä½¿ç”¨ï¼‰
    - name: å®‰è£… feeds
      run: cd openwrt && ./scripts/feeds install -a  # æ‰§è¡ŒOpenWrtè‡ªå¸¦è„šæœ¬ï¼Œå®‰è£…æ‰€æœ‰feedsè½¯ä»¶åŒ…

    # æ­¥éª¤11ï¼šåŠ è½½è‡ªå®šä¹‰é…ç½®ï¼ˆé…ç½®å›ºä»¶æœºå‹ã€åŠŸèƒ½ï¼Œæ‰§è¡Œç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬ï¼‰
    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      env:
        # æ‹¼æ¥è‡ªå®šä¹‰ç¼–è¯‘é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆæ¶æ„/.configï¼‰
        CONFIG_FILE_PATH: ${{ matrix.ARCHITECTURE }}/${{ env.CONFIG_FILE }}
      run: |
        # ç¡®ä¿å½“å‰ç›®å½•å¯å†™ï¼ˆé¿å…æƒé™ä¸è¶³å¯¼è‡´é…ç½®æ–‡ä»¶æ— æ³•ä¿®æ”¹ï¼‰
        sudo chmod -R +w ./
        # åˆ é™¤æºç ä¸­é»˜è®¤çš„mt76æ— çº¿é©±åŠ¨ï¼ˆæ›¿æ¢ä¸ºè”å‘ç§‘é—­æºé©±åŠ¨ï¼‰
        rm -rf openwrt/package/kernel/mt76/*
        # ç»™ç”¨æˆ·è¡¥ä¸ç›®å½•æ·»åŠ å¯æ‰§è¡Œæƒé™
        sudo chmod -R 775 $GITHUB_WORKSPACE/configfiles/userpatches/zhoufuli/
        # å¤åˆ¶è”å‘ç§‘WiFiä¸“å±è¡¥ä¸åˆ°æºç ç›®å½•ï¼ˆä¿ç•™ç›®å½•ç»“æ„ï¼Œæ˜¾ç¤ºè¿›åº¦ï¼‰
        rsync -av --progress $GITHUB_WORKSPACE/configfiles/userpatches/zhoufuli/ openwrt/
        # è‹¥å­˜åœ¨è‡ªå®šä¹‰filesç›®å½•ï¼ˆå›ºä»¶å†…ç½®æ–‡ä»¶ï¼‰ï¼Œç§»åŠ¨åˆ°æºç ç›®å½•
        [ -e files ] && mv files openwrt/files
        # è‹¥è‡ªå®šä¹‰ç¼–è¯‘é…ç½®æ–‡ä»¶å­˜åœ¨ï¼Œç§»åŠ¨åˆ°æºç ç›®å½•è¦†ç›–é»˜è®¤é…ç½®
        [ -e $CONFIG_FILE_PATH ] && mv $CONFIG_FILE_PATH openwrt/$CONFIG_FILE
        # æ³¨é‡Šæ‰é»˜è®¤çš„rockchip armv8æœºå‹é…ç½®ï¼ˆé¿å…å†²çªï¼Œå¯ç”¨è‡ªå®šä¹‰æœºå‹ï¼‰
        sed -i -E 's/^(CONFIG_TARGET_DEVICE_rockchip_armv8_DEVICE_[_a-zA-Z0-9-]+)=y$/# \1 is not set/' openwrt/.config
        # è¯»å–è”å‘ç§‘WiFiæœºå‹é…ç½®ï¼Œè¿½åŠ åˆ°æºç ç¼–è¯‘é…ç½®ä¸­
        getconfig=$(cat ${GITHUB_WORKSPACE}/armv8/g68_mtk_wifi.config)
        echo "$getconfig" >> openwrt/.config
        # è¯»å–è‡ªå®šä¹‰å†…æ ¸é…ç½®ï¼Œè¿½åŠ åˆ°å¯¹åº”æ¶æ„çš„å†…æ ¸é…ç½®æ–‡ä»¶ä¸­
        cat "${GITHUB_WORKSPACE}/configfiles/config-6.6.local" >> openwrt/target/linux/rockchip/armv8/config-6.6
        # ç»™ç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬æ·»åŠ å¯æ‰§è¡Œæƒé™
        chmod +x $DIY_P2_SH
        # åˆ‡æ¢åˆ°æºç ç›®å½•
        cd openwrt
        # æ‰§è¡Œç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬ï¼ˆè”å‘ç§‘WiFiä¸“å±é…ç½®ã€å›ºä»¶ä¼˜åŒ–ç­‰ï¼‰
        $GITHUB_WORKSPACE/$DIY_P2_SH

    # æ³¨é‡Šæ‰çš„SSHè¿æ¥æ­¥éª¤ï¼ˆå¦‚éœ€è¿œç¨‹è°ƒè¯•ç¼–è¯‘ç¯å¢ƒå¯å¯ç”¨ï¼Œéœ€é…ç½®Telegramé€šçŸ¥ï¼‰
    # - name: SSH è¿æ¥åˆ° Actions
      # uses: P3TERX/ssh2actions@main
      # if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
      # env:
        # TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        # TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    # æ­¥éª¤12ï¼šä¸‹è½½è½¯ä»¶åŒ…ï¼ˆé¢„ä¸‹è½½ç¼–è¯‘æ‰€éœ€çš„æ‰€æœ‰è½¯ä»¶åŒ…ï¼Œé¿å…ç¼–è¯‘è¿‡ç¨‹ä¸­ç½‘ç»œé—®é¢˜ï¼‰
    - name: ä¸‹è½½è½¯ä»¶åŒ…
      id: package  # æ­¥éª¤IDï¼Œç”¨äºåç»­æ­¥éª¤åˆ¤æ–­æ‰§è¡Œç»“æœ
      run: |
        # åˆ‡æ¢åˆ°æºç ç›®å½•
        cd openwrt
        # ç”Ÿæˆæœ€ç»ˆç¼–è¯‘é…ç½®ï¼ˆæ ¹æ®.configæ–‡ä»¶ç”Ÿæˆå®Œæ•´é…ç½®ï¼‰
        make defconfig
        # å¹¶è¡Œä¸‹è½½è½¯ä»¶åŒ…ï¼ˆ-j8ï¼š8çº¿ç¨‹ä¸‹è½½ï¼Œæé«˜æ•ˆç‡ï¼‰
        make download -j8
        # æŸ¥æ‰¾ä¸‹è½½ç›®å½•ä¸­å°äº1024å­—èŠ‚çš„æ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯ä¸‹è½½å¤±è´¥çš„æ®‹ç¼ºæ–‡ä»¶ï¼‰
        find dl -size -1024c -exec ls -l {} \;
        # åˆ é™¤ä¸‹è½½å¤±è´¥çš„æ®‹ç¼ºæ–‡ä»¶
        find dl -size -1024c -exec rm -f {} \;

    # æ­¥éª¤13ï¼šç¼–è¯‘å›ºä»¶ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼Œæ‰§è¡ŒOpenWrtç¼–è¯‘å‘½ä»¤ï¼‰
    - name: ç¼–è¯‘å›ºä»¶
      id: compile  # æ­¥éª¤IDï¼Œç”¨äºåç»­æ­¥éª¤åˆ¤æ–­æ‰§è¡Œç»“æœ
      run: |
        # åˆ‡æ¢åˆ°æºç ç›®å½•
        cd openwrt
        # æ‰“å°å½“å‰CPUæ ¸å¿ƒæ•°ï¼Œç”¨äºå¹¶è¡Œç¼–è¯‘
        echo -e "$(nproc) thread compile"
        # ç¬¬ä¸€æ­¥ï¼šå¤šçº¿ç¨‹ç¼–è¯‘ï¼ˆä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒï¼Œæé«˜ç¼–è¯‘é€Ÿåº¦ï¼‰
        make -j$(nproc) || \
        # ç¬¬äºŒæ­¥ï¼šå•çº¿ç¨‹ç¼–è¯‘ï¼ˆè‹¥å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œåˆ‡æ¢å•çº¿ç¨‹é‡è¯•ï¼‰
        make -j1 || \
        # ç¬¬ä¸‰æ­¥ï¼šå•çº¿ç¨‹è¯¦ç»†è¾“å‡ºç¼–è¯‘ï¼ˆè‹¥ä»å¤±è´¥ï¼Œè¾“å‡ºè¯¦ç»†æ—¥å¿—ä¾¿äºæ’é”™ï¼‰
        make -j1 V=s
        # ç”Ÿæˆç¼–è¯‘æ—¶é—´æˆ³ï¼Œå†™å…¥ç¯å¢ƒå˜é‡ï¼ˆç”¨äºå›ºä»¶å‘½åï¼‰
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        # æ ‡è®°ç¼–è¯‘æˆåŠŸï¼Œå†™å…¥æ­¥éª¤è¾“å‡ºç»“æœ
        echo "status=success" >> ${GITHUB_OUTPUT}

    # æ­¥éª¤14ï¼šæ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆç¼–è¯‘å®Œæˆåï¼ŒæŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µï¼‰
    - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
      if: (!cancelled())  # æ¡ä»¶ï¼šå·¥ä½œæµæœªè¢«æ‰‹åŠ¨å–æ¶ˆæ—¶æ‰§è¡Œ
      run: df -hT  # æŸ¥çœ‹ç£ç›˜æŒ‚è½½ã€å®¹é‡ã€æ–‡ä»¶ç³»ç»Ÿç±»å‹

    # æ­¥éª¤15ï¼šä¸Šä¼ binæ–‡ä»¶å¤¹ï¼ˆä¸Šä¼ å®Œæ•´çš„ç¼–è¯‘äº§ç‰©ç›®å½•ï¼ŒåŒ…å«ä¸­é—´æ–‡ä»¶å’Œå›ºä»¶ï¼‰
    - name: ä¸Šä¼  bin æ–‡ä»¶å¤¹
      uses: actions/upload-artifact@main  # è°ƒç”¨GitHubå®˜æ–¹ä¸Šä¼ äº§ç‰©Action
      # æ¡ä»¶ï¼šç¼–è¯‘æˆåŠŸ ä¸” å¯ç”¨UPLOAD_BIN_DIRé…ç½®
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        # ä¸Šä¼ äº§ç‰©åç§°ï¼ˆåŒ…å«ç¼–è¯‘æ—¶é—´æˆ³ï¼‰
        name: OpenWrt_bin${{ env.FILE_DATE }}
        # ä¸Šä¼ æ–‡ä»¶è·¯å¾„ï¼ˆæºç ç›®å½•ä¸‹çš„binæ–‡ä»¶å¤¹ï¼‰
        path: openwrt/bin

    # æ­¥éª¤16ï¼šæ•´ç†å›ºä»¶æ–‡ä»¶ï¼ˆç­›é€‰å‡ºå¯ç”¨çš„å›ºä»¶æ–‡ä»¶ï¼Œåˆ é™¤å†—ä½™çš„packagesç›®å½•ï¼‰
    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize  # æ­¥éª¤IDï¼Œç”¨äºåç»­æ­¥éª¤åˆ¤æ–­æ‰§è¡Œç»“æœ
      # æ¡ä»¶ï¼šå¯ç”¨UPLOAD_FIRMWAREé…ç½® ä¸” å·¥ä½œæµæœªè¢«æ‰‹åŠ¨å–æ¶ˆ
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        # åˆ‡æ¢åˆ°å›ºä»¶è¾“å‡ºç›®å½•ï¼ˆopenwrt/bin/targets/æ¶æ„/æœºå‹ï¼‰
        cd openwrt/bin/targets/*/*
        # åˆ é™¤packagesç›®å½•ï¼ˆè½¯ä»¶åŒ…ç›®å½•ï¼Œä½“ç§¯å¤§ä¸”éå¿…éœ€ï¼‰
        rm -rf packages
        # å°†å›ºä»¶ç›®å½•è·¯å¾„å†™å…¥ç¯å¢ƒå˜é‡ï¼Œåç»­æ­¥éª¤å¯å¤ç”¨
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        # æ ‡è®°æ•´ç†æˆåŠŸï¼Œå†™å…¥æ­¥éª¤è¾“å‡ºç»“æœ
        echo "status=success" >> ${GITHUB_OUTPUT}

    # æ­¥éª¤17ï¼šä¸Šä¼ å›ºä»¶ç›®å½•ï¼ˆä¸Šä¼ æ•´ç†åçš„å¯ç”¨å›ºä»¶æ–‡ä»¶ï¼‰
    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main  # è°ƒç”¨GitHubå®˜æ–¹ä¸Šä¼ äº§ç‰©Action
      # æ¡ä»¶ï¼šå›ºä»¶æ•´ç†æˆåŠŸ ä¸” å·¥ä½œæµæœªè¢«æ‰‹åŠ¨å–æ¶ˆ
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        # ä¸Šä¼ äº§ç‰©åç§°ï¼ˆåŒ…å«ç¼–è¯‘æ—¶é—´æˆ³ï¼‰
        name: OpenWrt_firmware${{ env.FILE_DATE }}
        # ä¸Šä¼ æ–‡ä»¶è·¯å¾„ï¼ˆæ•´ç†åçš„å›ºä»¶ç›®å½•ï¼‰
        path: ${{ env.FIRMWARE }}

    # æ­¥éª¤18ï¼šç”Ÿæˆå‘å¸ƒæ ‡ç­¾ï¼ˆåˆ›å»ºReleasesæ ‡ç­¾å’Œè¯´æ˜æ–‡æ¡£ï¼‰
    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag  # æ­¥éª¤IDï¼Œç”¨äºåç»­æ­¥éª¤åˆ¤æ–­æ‰§è¡Œç»“æœ
      # æ¡ä»¶ï¼šç¼–è¯‘æˆåŠŸ ä¸” å¯ç”¨UPLOAD_RELEASEé…ç½® ä¸” å·¥ä½œæµæœªè¢«æ‰‹åŠ¨å–æ¶ˆ
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        # ç”ŸæˆReleasesæ ‡ç­¾åç§°ï¼ˆåŒ…å«æ—¶é—´æˆ³ã€æ¶æ„ã€å›ºä»¶ç±»å‹ï¼‰
        echo "release_tag=$(date +"%Y.%m.%d-%H.%M")-${{ matrix.ARCHITECTURE }}-mtkwifi" >> ${GITHUB_OUTPUT}
        # åˆ›å»ºå‘å¸ƒè¯´æ˜æ–‡ä»¶
        touch release.txt
        # å†™å…¥å‘å¸ƒè¯´æ˜å†…å®¹ï¼ˆæ¶æ„ã€æºç ã€åˆ†æ”¯ã€ç¼–è¯‘æ—¶é—´ã€ç®¡ç†åœ°å€ç­‰ï¼‰
        echo "
        ğŸ’» æ¶æ„: ${{ matrix.ARCHITECTURE }}

        ğŸ“‚ æºç : ${{ env.REPO_URL }}

        ğŸŒ³ åˆ†æ”¯: ${{ matrix.REPO_BRANCH }}

        â±ï¸ ç¼–è¯‘æ—¶é—´: $(date +"%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")

        ğŸŒ ç®¡ç†åœ°å€: 192.168.100.1

        ğŸ‘¤ ç”¨æˆ·å: root

        ğŸ”’ å¯†ç : password

        ğŸ“’ è¯´æ˜: å•ç½‘å£è®¾å¤‡é»˜è®¤ç½‘å£ä¸ºLANï¼Œæ—è·¯ç”±æ¨¡å¼ï¼Œéœ€è¦æ¥å…¥ä¸»è·¯ç”±å™¨åè¿›åå°æŸ¥æ‰¾å¯¹åº”IPåœ°å€è®¿é—®ï¼Œåä¹‹åŒç½‘å£è®¾å¤‡é»˜è®¤ç½‘å£ä¸ºWAN+LANï¼Œä¸»è·¯ç”±æ¨¡å¼ï¼Œä¸‹é¢çš„é•œåƒæ–‡ä»¶éƒ½æ˜¯é›†æˆè”å‘ç§‘é—­æºWiFié©±åŠ¨çš„å›ºä»¶ï¼Œæ³¨æ„ä¸å¯ä¸å¼€æºWiFié©±åŠ¨ç‰ˆæœ¬é€šåˆ· " >> release.txt
        # æ ‡è®°æ ‡ç­¾ç”ŸæˆæˆåŠŸï¼Œå†™å…¥æ­¥éª¤è¾“å‡ºç»“æœ
        echo "status=success" >> ${GITHUB_OUTPUT}

    # æ­¥éª¤19ï¼šè‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ°Releasesï¼ˆå°†æ•´ç†åçš„å›ºä»¶ä¸Šä¼ åˆ°GitHub Releasesï¼‰
    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
      uses: softprops/action-gh-release@v2  # è°ƒç”¨ç¬¬ä¸‰æ–¹Releaseså‘å¸ƒAction
      # æ¡ä»¶ï¼šæ ‡ç­¾ç”ŸæˆæˆåŠŸ ä¸” å·¥ä½œæµæœªè¢«æ‰‹åŠ¨å–æ¶ˆ
      if: steps.tag.outputs.status == 'success' && !cancelled()
      with:
        # Releasesæ ‡ç­¾åç§°ï¼ˆä½¿ç”¨æ­¥éª¤18ç”Ÿæˆçš„æ ‡ç­¾ï¼‰
        tag_name: ${{ steps.tag.outputs.release_tag }}
        # Releasesæ­£æ–‡å†…å®¹ï¼ˆä½¿ç”¨æ­¥éª¤18ç”Ÿæˆçš„release.txtæ–‡ä»¶ï¼‰
        body_path: release.txt
        # ä¸Šä¼ åˆ°Releasesçš„æ–‡ä»¶ï¼ˆæ•´ç†åçš„æ‰€æœ‰å›ºä»¶æ–‡ä»¶ï¼‰
        files: ${{ env.FIRMWARE }}/*

    # æ­¥éª¤20ï¼šåˆ é™¤è¿è¡Œè®°å½•ï¼ˆæ¸…ç†æ—§çš„GitHub Actionsè¿è¡Œè®°å½•ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ï¼‰
    - name: åˆ é™¤è¿è¡Œè®°å½•
      uses: xiaomeng9597/delete-workflow-runs@main  # è°ƒç”¨ç¬¬ä¸‰æ–¹åˆ é™¤è¿è¡Œè®°å½•Action
      with:
        retain_days: 20  # ä¿ç•™æœ€è¿‘20å¤©çš„è¿è¡Œè®°å½•
        keep_minimum_runs: 15  # è‡³å°‘ä¿ç•™15æ¡è¿è¡Œè®°å½•ï¼ˆå³ä½¿è¶…è¿‡20å¤©ï¼‰
        token: ${{ env.GITHUB_TOKEN }}  # è®¿é—®ä»¤ç‰Œï¼ˆç”¨äºæ“ä½œä»“åº“ï¼‰

    # æ­¥éª¤21ï¼šåˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶ï¼ˆæ¸…ç†æ—§çš„Releasesï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ï¼‰
    - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
      uses: dev-drprasad/delete-older-releases@v0.3.3  # è°ƒç”¨ç¬¬ä¸‰æ–¹åˆ é™¤æ—§Releases Action
      # æ¡ä»¶ï¼šå¯ç”¨UPLOAD_RELEASEé…ç½® ä¸” å·¥ä½œæµæœªè¢«æ‰‹åŠ¨å–æ¶ˆ
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 60  # ä¿ç•™æœ€è¿‘60ä¸ªReleasesï¼ˆå›ºä»¶ç‰ˆæœ¬ï¼‰
        delete_tags: true  # åŒæ—¶åˆ é™¤å¯¹åº”çš„Gitæ ‡ç­¾
